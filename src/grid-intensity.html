<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Grid Aware Demo - Grid Intensity</title>
    <link rel="stylesheet" href="/static/index_1.css">
</head>
<body>
    <p>Choose to view the demo for:</p>
    <ul>
        <li>Grid-aware page based on <b>grid intensity</b>. (You are here)</li>
        <li><a href="/power-breakdown/">Grid-aware page based on <b>power breakdown</b></a>.</li>
    </ul>

    <h1>Grid Aware Website using Grid Intensity</h1>
    <p>This page uses grid intensity data from Electricity Maps and CO2.js to determine if the energy grid in your location is "dirtier" than average. Based on that, some of the design and content loaded by this page will change.</p>

    <h2>Colours</h2>
    <p id="colour-explainer">You're seeing the page in <span id="page-color">light mode</span>, which means either your local electricity grid is <span id="cleaner-dirtier">cleaner than average, or that no data was available for your region</span> .</p>

    <hr>

    <h2>Fonts</h2>
    <p id="font-explainer">You're also seeing a <span id="font-type">custom font (Depature Mono)</span> used on this page.</p>

    <hr>

    <h2>Data</h2>
    <p>This page has been modified based on the below data:</p>

    <pre>
        <code id="data">
            
        </code>
    </pre>

    <hr>

    <h2>How does it work?</h2>
    <p>This page uses the <a href="https://github.com/thegreenwebfoundation/grid-aware-websites">grid-aware-websites code library</a> to get the current energy grid intensity data from Electricity Maps. Based on the response, it will either return the regular site, or modify parts of the site to apply some low-impact web design practices (explained above).</p>
    <p>All of this work takes part in a <span id="platform">Cloudflare Worker</span>, meaning there is JavaScript execution on the client device for any of this to happen.</p>

    <h3>High-level diagram</h3>
    <figure>
        <img src="/static/grid-aware-high-level.png" alt="A diagram showing the flow of data via a web request from the browser, through an edge function, to the host server, and back.">
        <figcaption>A high-level diagram showing the ideas behind the `grid-aware-websites` project.</figcaption>
    </figure>

    <h3>Edge worker diagram</h3>
    <figure>
        <img src="/static/grid-aware-co2e.png" alt="A diagram showing the operations inside an edge worker. First a fetch request is made to get a webpage from the host. Then, a request is made to the Electricity Maps API to fetch grid intensity data for the electricity grid of the user. With this data, a check is performed to determine if grid-aware design changes should be applied.">
        <figcaption>A more detailed diagram showing the process that takes place inside the edge worker to determine if grid-aware design should be applied.</figcaption>
    </figure>

    <h3>Code snippet</h3>
    <p>This is a simplified snippet from the <span id="platform">Cloudflare Worker</span> that works on this page.</p>

    <pre>
        <code id="snippet">
// Import the things we need from the grid-aware-websites library
import { gridAwareCO2e} from 'grid-aware-websites';
import {cloudflare} from 'grid-aware-websites/plugins/edge';

export default {
    async fetch(request, env, ctx) {
        // First fetch the request
        const response = await fetch(request.url);
        // Then check if the request content type is HTML. If not, return the request as is.
        const contentType = response.headers.get('content-type');

        if (!contentType || !contentType.includes('text/html')) {
            return new Response(response.body, {
                ...response,
            });
        }

        // If the content type is HTML, we can then do the grid-aware checks, based on the user location.
        // Here we use the country, but you could also use lat-lon.
        let cfData = cloudflare.getLocation(request);
        let { country } = cfData;

        // If we can't get that information, return the response as it is.
        // We also add a header to the response to show that the country was not found. (optional)
        if (!country) {
            return new Response(response.body, {
                ...response,
                headers: {
                    ...response.headers,
                    'grid-aware': 'Error - Country not found',
                },
            });
        }

        // Fetch the grid data from Electricity Maps via the grid-aware-websites library
        const gridData = await gridAwareCO2e(country, 'AN_API_KEY_HERE');

        // If the grid data status is error, return the response as is.
        if (gridData.status === 'error') {
            return new Response(response.body, {
                ...response,
                headers: {
                    ...response.headers,
                    'grid-aware': 'Error - Unable to fetch grid data',
                },
            });
        }

        // If the gridAware value is set to true, we add a data-grid-aware attribute to the HTML tag of the page using the HTMLRewriter
        if (gridData.gridAware) {
            const rewriter = new HTMLRewriter()
                .on('html', {
                    element(element) {
                        element.setAttribute('data-grid-aware', 'true');
                    },
                })
                
                // ... Add more rewriter rules here. I have removed them for brevity.

            // Return the response with the rewriter applied
            // You can also return some of the grid-aware data in the headers of the response if you want.
            return new Response(rewriter.transform(response).body, {
                ...response,
                contentType: 'text/html',
                headers: {
                    ...response.headers,
                    'grid-aware': 'true',
                },
            });
        }


        // Otherwise, if the gridAware value is false, we return the response as is.
        // Again, we can add some headers to the response to show that the page is not grid-aware.
        return new Response(addData.transform(response).body, {
            ...response,
            contentType: 'text/html',
            headers: {
                ...response.headers,
                'grid-aware': 'false',
            },
        });
    },
};            
        </code>
    </pre>

<hr>

    <p>Choose to view the demo for:</p>
    <ul>
        <li>Grid-aware page based on <b>grid intensity</b>. (You are here)</li>
        <li><a href="/power-breakdown/">Grid-aware page based on <b>power breakdown</b></a>.</li>
    </ul>

</body>
</html>
